#!/bin/bash
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# System Request : Debian 9+/Ubuntu 18.04+/20+
# Developer  » Abdul NorthAfrica࿐
# Email      » yourmail@example.com
# Telegram   » https://t.me/northafrica9
# Group      » https://t.me/groupnorthafrica
# Whatsapp   » wa.me/+212600000000
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

export DEBIAN_FRONTEND=noninteractive
OS=$(uname -m)
MYIP=$(wget -qO- ifconfig.me)
domain=$(cat /root/domain 2>/dev/null)
MYIP2="s/xxxxxxxxx/$domain/g"

# ======================================================
# 1 • DOWNLOAD & EXTRACT VPN.ZIP
# ======================================================
function ovpn_install() {
    rm -rf /etc/openvpn
    mkdir -p /etc/openvpn

    echo "Downloading vpn.zip ..."
    wget -O /etc/openvpn/vpn.zip "https://raw.githubusercontent.com/asloma1984/NorthAfrica/main/files/vpn.zip" >/dev/null 2>&1 

    if [[ ! -f /etc/openvpn/vpn.zip ]]; then
        echo "ERROR: vpn.zip not downloaded!"
        exit 1
    fi

    unzip -o /etc/openvpn/vpn.zip -d /etc/openvpn/ >/dev/null 2>&1

    if [[ $? -ne 0 ]]; then
        echo "ERROR: unzip failed — vpn.zip is corrupted!"
        exit 1
    fi

    rm -f /etc/openvpn/vpn.zip
    chown -R root:root /etc/openvpn/server/
}

# ======================================================
# 2 • ENABLE OPENVPN SERVICES
# ======================================================
function config_easy() {

    mkdir -p /usr/lib/openvpn/
    cp /usr/lib/x86_64-linux-gnu/openvpn/plugins/openvpn-plugin-auth-pam.so \
       /usr/lib/openvpn/openvpn-plugin-auth-pam.so

    sed -i 's/#AUTOSTART="all"/AUTOSTART="all"/g' /etc/default/openvpn

    systemctl enable openvpn-server@server-tcp >/dev/null 2>&1
    systemctl enable openvpn-server@server-udp >/dev/null 2>&1

    systemctl restart openvpn-server@server-tcp
    systemctl restart openvpn-server@server-udp
}

# ======================================================
# 3 • GENERATE .OVPN FILES
# ======================================================
function make_follow() {

    echo 1 > /proc/sys/net/ipv4/ip_forward
    sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g' /etc/sysctl.conf

    mkdir -p /var/www/html/

    cat > /etc/openvpn/tcp.ovpn <<-END
client
dev tun
proto tcp
remote xxxxxxxxx 1194
resolv-retry infinite
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i $MYIP2 /etc/openvpn/tcp.ovpn

    cat > /etc/openvpn/udp.ovpn <<-END
client
dev tun
proto udp
remote xxxxxxxxx 2200
resolv-retry infinite
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i $MYIP2 /etc/openvpn/udp.ovpn

    cat > /etc/openvpn/ws-ssl.ovpn <<-END
client
dev tun
proto tcp
remote xxxxxxxxx 443
resolv-retry infinite
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i $MYIP2 /etc/openvpn/ws-ssl.ovpn

    cat > /etc/openvpn/ssl.ovpn <<-END
client
dev tun
proto tcp
remote xxxxxxxxx 443
resolv-retry infinite
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i $MYIP2 /etc/openvpn/ssl.ovpn
}

# ======================================================
# 4 • ATTACH CA CERTIFICATE
# ======================================================
function cert_ovpn() {

    for cfg in tcp udp ws-ssl ssl; do

        echo '<ca>' >> /etc/openvpn/$cfg.ovpn
        cat /etc/openvpn/server/ca.crt >> /etc/openvpn/$cfg.ovpn
        echo '</ca>' >> /etc/openvpn/$cfg.ovpn

        cp /etc/openvpn/$cfg.ovpn /var/www/html/$cfg.ovpn
    done

    cd /var/www/html/
    zip NorthAfrica-VPN.zip tcp.ovpn udp.ovpn ssl.ovpn ws-ssl.ovpn >/dev/null 2>&1
    cd
}

# ======================================================
# 5 • GENERATE HTML DOWNLOAD PAGE
# ======================================================
function html_page() {

cat <<HTML > /var/www/html/index.html
<!DOCTYPE html>
<html>
<head>
<title>NorthAfrica OVPN Config</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
<div class="container text-center mt-5">
<h2>OpenVPN Config Download</h2>
<p>By <a href="https://t.me/northafrica9">@northafrica9</a></p>

<div class="list-group">
<a class="list-group-item" href="http://IP-ADDRESS:81/tcp.ovpn">TCP</a>
<a class="list-group-item" href="http://IP-ADDRESS:81/udp.ovpn">UDP</a>
<a class="list-group-item" href="http://IP-ADDRESS:81/ssl.ovpn">SSL</a>
<a class="list-group-item" href="http://IP-ADDRESS:81/ws-ssl.ovpn">WS-SSL</a>
<a class="list-group-item" href="http://IP-ADDRESS:81/NorthAfrica-VPN.zip">ZIP (All Configs)</a>
</div>

<p class="mt-4">Join Our Group: <a href="https://t.me/groupnorthafrica">Click Here</a></p>
</div>
</body>
</html>
HTML

sed -i "s|IP-ADDRESS|$MYIP|g" /var/www/html/index.html
}

# ======================================================
# 6 • RUN INSTALLATION
# ======================================================
function install_ovpn() {
    ovpn_install
    config_easy
    make_follow
    cert_ovpn
    html_page

    systemctl restart openvpn

    echo -e "\e[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
    echo -e "\e[32m OpenVPN Installed Successfully! \e[0m"
    echo -e "\e[33m Download Configs:\e[0m http://$MYIP:81"
    echo -e "\e[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\e[0m"
    echo -e "Telegram : https://t.me/northafrica9"
    echo -e "Group    : https://t.me/groupnorthafrica"
    echo -e "Whatsapp : wa.me/+212600000000"
}

install_ovpn