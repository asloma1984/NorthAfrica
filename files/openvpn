#!/bin/bash
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# North Africa OpenVPN Installer
# System Request : Debian 9+/Ubuntu 18+
# Developer      : NORTH AFRICA TEAM
# Telegram       : https://t.me/northafrica9
# Group          : https://t.me/groupnorthafrica
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

export DEBIAN_FRONTEND=noninteractive

# Detect system information
MYIP=$(curl -sS ipv4.icanhazip.com)
DOMAIN_FILE="/root/domain"
if [[ -f "$DOMAIN_FILE" ]]; then
    DOMAIN=$(cat /root/domain)
else
    DOMAIN="$MYIP"
fi
REPLACE_DOMAIN="s/xxxxxxxxx/$DOMAIN/g"

echo ""
echo "=========================================="
echo "     North Africa – OpenVPN Installer     "
echo "=========================================="
echo "Server IP    : $MYIP"
echo "Domain Used  : $DOMAIN"
echo "=========================================="
sleep 2

# ---------------------------------------------------
# 1. Install packages
# ---------------------------------------------------
echo "[1] Installing required packages..."
apt update -y >/dev/null 2>&1
apt install -y openvpn easy-rsa zip unzip nginx iptables-persistent >/dev/null 2>&1

# ---------------------------------------------------
# 2. Setup directories
# ---------------------------------------------------
echo "[2] Preparing OpenVPN directories..."
rm -rf /etc/openvpn
mkdir -p /etc/openvpn/server
mkdir -p /etc/openvpn/client

# ---------------------------------------------------
# 3. Setup Easy-RSA PKI (Certificates)
# ---------------------------------------------------
echo "[3] Generating certificates..."

EASYRSA_DIR="/etc/openvpn/server/easy-rsa"
mkdir -p $EASYRSA_DIR
cp -r /usr/share/easy-rsa/* $EASYRSA_DIR/

cd $EASYRSA_DIR
export EASYRSA_BATCH=1
export EASYRSA_PKI="$EASYRSA_DIR/pki"

./easyrsa init-pki >/dev/null 2>&1
./easyrsa build-ca nopass >/dev/null 2>&1
./easyrsa gen-dh >/dev/null 2>&1
./easyrsa build-server-full server nopass >/dev/null 2>&1
./easyrsa gen-crl >/dev/null 2>&1

# Copy keys
cp $EASYRSA_PKI/ca.crt              /etc/openvpn/server/
cp $EASYRSA_PKI/issued/server.crt   /etc/openvpn/server/
cp $EASYRSA_PKI/private/server.key  /etc/openvpn/server/
cp $EASYRSA_PKI/dh.pem              /etc/openvpn/server/
cp $EASYRSA_PKI/crl.pem             /etc/openvpn/server/

chmod 600 /etc/openvpn/server/server.key

# ---------------------------------------------------
# 4. Create OpenVPN Server Configs (TCP / UDP)
# ---------------------------------------------------
echo "[4] Creating server configuration..."

# TCP
cat > /etc/openvpn/server/server-tcp.conf <<EOF
port 1194
proto tcp
dev tun
server 10.8.0.0 255.255.255.0
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 1.1.1.1"
push "dhcp-option DNS 1.0.0.1"
persist-key
persist-tun
keepalive 10 120
ca ca.crt
cert server.crt
key server.key
dh dh.pem
crl-verify crl.pem
cipher AES-256-CBC
auth SHA256
compress lz4-v2
status /var/log/openvpn-status-tcp.log
verb 3
EOF

# UDP
cat > /etc/openvpn/server/server-udp.conf <<EOF
port 2200
proto udp
dev tun
server 10.9.0.0 255.255.255.0
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 1.1.1.1"
push "dhcp-option DNS 1.0.0.1"
persist-key
persist-tun
keepalive 10 120
ca ca.crt
cert server.crt
key server.key
dh dh.pem
crl-verify crl.pem
cipher AES-256-CBC
auth SHA256
compress lz4-v2
status /var/log/openvpn-status-udp.log
verb 3
EOF

# ---------------------------------------------------
# 5. Enable IP Forwarding & NAT
# ---------------------------------------------------
echo "[5] Enabling IP forwarding..."

echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p >/dev/null 2>&1

# Detect network interface
IFACE=$(ip -o -4 route show to default | awk '{print $5}' | head -n1)

# NAT
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o $IFACE -j MASQUERADE
iptables -t nat -A POSTROUTING -s 10.9.0.0/24 -o $IFACE -j MASQUERADE

netfilter-persistent save >/dev/null 2>&1

# ---------------------------------------------------
# 6. Create Client Files (.ovpn)
# ---------------------------------------------------
echo "[6] Generating client configuration files..."

# TCP Client
cat > /etc/openvpn/client/tcp.ovpn <<EOF
client
dev tun
proto tcp
remote xxxxxxxxx 1194
resolv-retry infinite
nobind
persist-key
persist-tun
auth-user-pass
cipher AES-256-CBC
auth SHA256
compress lz4-v2
verb 3

<ca>
EOF
sed -i $REPLACE_DOMAIN /etc/openvpn/client/tcp.ovpn
cat /etc/openvpn/server/ca.crt >> /etc/openvpn/client/tcp.ovpn
echo "</ca>" >> /etc/openvpn/client/tcp.ovpn

# UDP Client
cat > /etc/openvpn/client/udp.ovpn <<EOF
client
dev tun
proto udp
remote xxxxxxxxx 2200
resolv-retry infinite
nobind
persist-key
persist-tun
auth-user-pass
cipher AES-256-CBC
auth SHA256
compress lz4-v2
verb 3

<ca>
EOF
sed -i $REPLACE_DOMAIN /etc/openvpn/client/udp.ovpn
cat /etc/openvpn/server/ca.crt >> /etc/openvpn/client/udp.ovpn
echo "</ca>" >> /etc/openvpn/client/udp.ovpn

# Duplicate for ssl & ws-ssl
cp /etc/openvpn/client/tcp.ovpn /etc/openvpn/client/ssl.ovpn
cp /etc/openvpn/client/tcp.ovpn /etc/openvpn/client/ws-ssl.ovpn

# Copy to nginx web folder
cp /etc/openvpn/client/*.ovpn /var/www/html/

cd /var/www/html
zip NorthAfrica-OVPN.zip *.ovpn >/dev/null 2>&1

# ---------------------------------------------------
# 7. Create HTML Download Page
# ---------------------------------------------------
echo "[7] Creating download page..."

cat > /var/www/html/index.html <<EOF
<html>
<head>
<title>North Africa OpenVPN Config</title>
</head>
<body>
<h2>Download OpenVPN Config Files</h2>
<ul>
<li><a href="https://$DOMAIN:81/tcp.ovpn">TCP 1194</a></li>
<li><a href="https://$DOMAIN:81/udp.ovpn">UDP 2200</a></li>
<li><a href="https://$DOMAIN:81/ssl.ovpn">SSL 443</a></li>
<li><a href="https://$DOMAIN:81/ws-ssl.ovpn">WS SSL 443</a></li>
<li><a href="https://$DOMAIN:81/NorthAfrica-OVPN.zip">ALL (ZIP)</a></li>
</ul>
</body>
</html>
EOF

# ---------------------------------------------------
# 8. Enable & Start Services
# ---------------------------------------------------
echo "[8] Starting OpenVPN services..."

systemctl enable openvpn-server@server-tcp
systemctl enable openvpn-server@server-udp

systemctl restart openvpn-server@server-tcp
systemctl restart openvpn-server@server-udp

systemctl restart nginx

echo "=========================================="
echo "     OpenVPN Installed Successfully!       "
echo "=========================================="
echo "TCP Port     : 1194"
echo "UDP Port     : 2200"
echo "Download OVPN files at:"
echo "https://$DOMAIN:81/"
echo "=========================================="