#!/bin/bash
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# System Request : Debian 9 to 13 / Ubuntu 18 to 25
# Developer  » Abdul (NorthAfrica Script)
# Channel    » https://t.me/northafrica9
# Group      » https://t.me/groupnorthafrica
#
# Purpose    » Install & configure OpenVPN (TCP/UDP/WS-SSL)
#              and generate .ovpn files using SERVER IP
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

set -e
export DEBIAN_FRONTEND=noninteractive

OS_ARCH="$(uname -m)"
MYIP="$(wget -qO- ipinfo.io/ip || curl -sS ifconfig.me)"
DOMAIN="$(cat /root/domain 2>/dev/null || echo "")"

# Use IP (not domain) in all .ovpn profiles
MYIP2="s/xxxxxxxxx/${MYIP}/g"

# ─────────────────────────────────────────────────────
# Helper: ensure OpenVPN & Easy-RSA are installed
# ─────────────────────────────────────────────────────
install_packages() {
    apt-get update -y
    apt-get install -y openvpn easy-rsa zip unzip >/dev/null 2>&1 || true
}

# ─────────────────────────────────────────────────────
# Download server configs (vpn.zip) and Easy-RSA
# ─────────────────────────────────────────────────────
ovpn_install() {
    rm -rf /etc/openvpn
    mkdir -p /etc/openvpn

    wget -q -O /etc/openvpn/vpn.zip \
      "https://raw.githubusercontent.com/jaka1m/project/main/ssh/vpn.zip"

    unzip -qo /etc/openvpn/vpn.zip -d /etc/openvpn/
    rm -f /etc/openvpn/vpn.zip

    chown -R root:root /etc/openvpn/server/easy-rsa/ 2>/dev/null || true
}

# ─────────────────────────────────────────────────────
# Configure OpenVPN services + PAM plugin
# ─────────────────────────────────────────────────────
config_easy() {
    mkdir -p /usr/lib/openvpn/

    # Try to find the PAM plugin automatically
    PAM_PLUGIN="$(find /usr/lib -name 'openvpn-plugin-auth-pam.so' -print -quit 2>/dev/null || true)"
    if [[ -n "$PAM_PLUGIN" ]]; then
        cp "$PAM_PLUGIN" /usr/lib/openvpn/openvpn-plugin-auth-pam.so 2>/dev/null || true
    fi

    # Enable autostart for OpenVPN if file exists
    if [[ -f /etc/default/openvpn ]]; then
        sed -i 's/#AUTOSTART="all"/AUTOSTART="all"/g' /etc/default/openvpn
    fi

    # There are two possible unit name styles, handle both
    if systemctl list-unit-files | grep -q '^openvpn-server@\.service'; then
        # Debian/Ubuntu modern style
        systemctl enable --now openvpn-server@server-tcp.service 2>/dev/null || true
        systemctl enable --now openvpn-server@server-udp.service 2>/dev/null || true
    else
        # Older style (if present)
        systemctl enable --now openvpn@server-tcp.service 2>/dev/null || true
        systemctl enable --now openvpn@server-udp.service 2>/dev/null || true
    fi

    systemctl restart openvpn 2>/dev/null || true
}

# ─────────────────────────────────────────────────────
# Generate client profiles (TCP / UDP / WS-SSL / SSL)
# ─────────────────────────────────────────────────────
make_follow() {
    # Enable IP forwarding
    echo 1 > /proc/sys/net/ipv4/ip_forward
    sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g' /etc/sysctl.conf || true

    # TCP profile
    cat > /etc/openvpn/tcp.ovpn <<-END
client
dev tun
proto tcp
remote xxxxxxxxx 1194
resolv-retry infinite
route-method exe
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i "${MYIP2}" /etc/openvpn/tcp.ovpn

    # UDP profile
    cat > /etc/openvpn/udp.ovpn <<-END
client
dev tun
proto udp
remote xxxxxxxxx 2200
resolv-retry infinite
route-method exe
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i "${MYIP2}" /etc/openvpn/udp.ovpn

    # WS-SSL profile (through port 443)
    cat > /etc/openvpn/ws-ssl.ovpn <<-END
client
dev tun
proto tcp
remote xxxxxxxxx 443
resolv-retry infinite
route-method exe
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i "${MYIP2}" /etc/openvpn/ws-ssl.ovpn

    # Plain SSL profile (also 443)
    cat > /etc/openvpn/ssl.ovpn <<-END
client
dev tun
proto tcp
remote xxxxxxxxx 443
resolv-retry infinite
route-method exe
nobind
persist-key
persist-tun
auth-user-pass
comp-lzo
verb 3
END
    sed -i "${MYIP2}" /etc/openvpn/ssl.ovpn
}

# ─────────────────────────────────────────────────────
# Append CA cert to profiles + create download page
# ─────────────────────────────────────────────────────
cert_ovpn() {
    CA_FILE="/etc/openvpn/server/ca.crt"

    if [[ -f "$CA_FILE" ]]; then
        # TCP
        {
            echo '<ca>'
            cat "$CA_FILE"
            echo '</ca>'
        } >> /etc/openvpn/tcp.ovpn

        # UDP
        {
            echo '<ca>'
            cat "$CA_FILE"
            echo '</ca>'
        } >> /etc/openvpn/udp.ovpn

        # WS-SSL
        {
            echo '<ca>'
            cat "$CA_FILE"
            echo '</ca>'
        } >> /etc/openvpn/ws-ssl.ovpn

        # SSL (same as WS-SSL content)
        {
            echo '<ca>'
            cat "$CA_FILE"
            echo '</ca>'
        } >> /etc/openvpn/ssl.ovpn
    fi

    mkdir -p /var/www/html

    cp /etc/openvpn/tcp.ovpn     /var/www/html/tcp.ovpn
    cp /etc/openvpn/udp.ovpn     /var/www/html/udp.ovpn
    cp /etc/openvpn/ssl.ovpn     /var/www/html/ssl.ovpn
    cp /etc/openvpn/ws-ssl.ovpn  /var/www/html/ws-ssl.ovpn

    # Zip all configs
    (
        cd /var/www/html || exit 0
        zip -q Kyt-Project.zip tcp.ovpn udp.ovpn ssl.ovpn ws-ssl.ovpn || true
    )

    # Simple download page (HTTPS on port 81, IP-based)
    cat <<'mySiteOvpn' > /var/www/html/index.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OVPN Config Download</title>
  <meta name="description" content="Server" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
  <meta name="theme-color" content="#000000" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.3/css/mdb.min.css" rel="stylesheet">
</head>
<body>
  <div class="container justify-content-center" style="margin-top:9em;margin-bottom:5em;">
    <div class="col-md">
      <div class="view">
        <img src="https://openvpn.net/wp-content/uploads/openvpn.jpg" class="card-img-top">
        <div class="mask rgba-white-slight"></div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Config List</h5><br />
          <ul class="list-group">
            <li class="list-group-item justify-content-between align-items-center" style="margin-bottom:1em;">
              <p>TCP <span class="badge light-blue darken-4">Android/iOS/PC/Modem</span></p>
              <a class="btn btn-outline-success waves-effect btn-sm" href="https://IP-ADDRESSS:81/tcp.ovpn" style="float:right;">
                <i class="fa fa-download"></i> Download
              </a>
            </li>
            <li class="list-group-item justify-content-between align-items-center" style="margin-bottom:1em;">
              <p>UDP <span class="badge light-blue darken-4">Android/iOS/PC/Modem</span></p>
              <a class="btn btn-outline-success waves-effect btn-sm" href="https://IP-ADDRESSS:81/udp.ovpn" style="float:right;">
                <i class="fa fa-download"></i> Download
              </a>
            </li>
            <li class="list-group-item justify-content-between align-items-center" style="margin-bottom:1em;">
              <p>SSL <span class="badge light-blue darken-4">Android/iOS/PC/Modem</span></p>
              <a class="btn btn-outline-success waves-effect btn-sm" href="https://IP-ADDRESSS:81/ssl.ovpn" style="float:right;">
                <i class="fa fa-download"></i> Download
              </a>
            </li>
            <li class="list-group-item justify-content-between align-items-center" style="margin-bottom:1em;">
              <p>WS SSL <span class="badge light-blue darken-4">Android/iOS/PC/Modem</span></p>
              <a class="btn btn-outline-success waves-effect btn-sm" href="https://IP-ADDRESSS:81/ws-ssl.ovpn" style="float:right;">
                <i class="fa fa-download"></i> Download
              </a>
            </li>
            <li class="list-group-item justify-content-between align-items-center" style="margin-bottom:1em;">
              <p>ALL.zip <span class="badge light-blue darken-4">Android/iOS/PC/Modem</span></p>
              <a class="btn btn-outline-success waves-effect btn-sm" href="https://IP-ADDRESSS:81/Kyt-Project.zip" style="float:right;">
                <i class="fa fa-download"></i> Download
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
mySiteOvpn

    # Replace placeholder with server IP
    sed -i "s|IP-ADDRESSS|${MYIP}|g" /var/www/html/index.html
}

# ─────────────────────────────────────────────────────
# Main installer
# ─────────────────────────────────────────────────────
install_ovpn() {
    install_packages
    ovpn_install
    config_easy
    make_follow
    make_follow   # keep as in original script
    cert_ovpn

    systemctl enable openvpn 2>/dev/null || true
    systemctl start openvpn  2>/dev/null || true
    systemctl restart openvpn 2>/dev/null || true
}

install_ovpn
