#!/bin/bash
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# System Request : Debian 9+/Ubuntu 18.04+/20+
# Developer  » Abdul NorthAfrica࿐
# Email      » yourmail@example.com
# Telegram   » https://t.me/YourChannel
# Group      » https://t.me/YourGroup
# Whatsapp   » wa.me/+212600000000
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

function send_log(){
    CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
    KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
    TIME="10"
    URL="https://api.telegram.org/bot$KEY/sendMessage"

    DATE_NOW=$(date +"%Y-%m-%d %H:%M:%S")
    TEXT="
<code>────────────────────</code>
<b>⚠️ VMESS QUOTA LIMIT REACHED ⚠️</b>
<code>────────────────────</code>
<code>Username  : </code><code>$user</code>
<code>Quota Limit : </code><code>$total2</code>
<code>Used Data   : </code><code>$total</code>
<code>Time        : </code><code>$DATE_NOW</code>
<code>────────────────────</code>
<b>Channel :</b> <a href='https://t.me/YourChannel'>@YourChannel</a>
<b>Group :</b> <a href='https://t.me/YourGroup'>Join Support</a>
"
    curl -s --max-time $TIME \
    -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" \
    $URL >/dev/null
}

function con() {
    local -i bytes=$1
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes}B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(( (bytes + 1023)/1024 ))KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(( (bytes + 1048575)/1048576 ))MB"
    else
        echo "$(( (bytes + 1073741823)/1073741824 ))GB"
    fi
}

# Main monitoring loop
while true; do
    sleep 5
    data=($(grep '^###' /etc/xray/config.json | cut -d ' ' -f 2 | sort | uniq))
    [[ ! -d /etc/limit/vmess ]] && mkdir -p /etc/limit/vmess

    for user in ${data[@]}; do
        xray api stats --server=127.0.0.1:10000 \
        -name "user>>>${user}>>>traffic>>>downlink" >& /tmp/${user}
        getThis=$(awk '{print $1}' /tmp/${user})

        if [[ ${getThis} != "failed" ]]; then
            downlink=$(xray api stats --server=127.0.0.1:10000 \
            -name "user>>>${user}>>>traffic>>>downlink" | grep -w "value" | awk '{print $2}' | cut -d '"' -f2)
            if [ -e /etc/limit/vmess/${user} ]; then
                plus2=$(cat /etc/limit/vmess/${user})
                if [[ ${#plus2} -gt 0 ]]; then
                    plus3=$(( ${downlink} + ${plus2} ))
                    echo "${plus3}" > /etc/limit/vmess/"${user}"
                else
                    echo "${downlink}" > /etc/limit/vmess/"${user}"
                fi
            else
                echo "${downlink}" > /etc/limit/vmess/"${user}"
            fi
            xray api stats --server=127.0.0.1:10000 \
            -name "user>>>${user}>>>traffic>>>downlink" -reset >/dev/null 2>&1
        fi
    done

    for user in ${data[@]}; do
        if [ -e /etc/vmess/${user} ]; then
            checkLimit=$(cat /etc/vmess/${user})
            if [[ ${#checkLimit} -gt 1 && -e /etc/limit/vmess/${user} ]]; then
                Usage=$(cat /etc/limit/vmess/${user})
                total=$(con ${Usage})
                total2=$(con ${checkLimit})
                if [[ ${Usage} -gt ${checkLimit} ]]; then
                    exp=$(grep -w "^### $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)

                    sed -i "/^### $user $exp/,/^},{/d" /etc/xray/config.json
                    sed -i "/^### $user $exp/d" /etc/vmess/.vmess.db

                    send_log

                    rm -rf /etc/limit/vmess/${user}
                    rm -f /etc/kyt/limit/vmess/ip/$user
                    rm -f /etc/vmess/$user
                    rm -f /etc/limit/vmess/$user
                    rm -f /etc/limit/vmess/quota/$user
                    rm -f /var/www/html/vmess-$user.txt

                    systemctl restart xray >/dev/null 2>&1
                fi
            fi
        fi
    done
done