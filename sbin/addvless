#!/bin/bash
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# System Request : Debian 9 to 13 / Ubuntu 18 to 25
# Developer  » Abdul (NorthAfrica Script)
# Channel    » https://t.me/northafrica9
# Group      » https://t.me/groupnorthafrica
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# North Africa Script

RED="\033[0;31m"
GREEN="\033[0;32m"
CYAN="\033[0;36m"
WHITE="\033[1;37m"
NC="\033[0m"
BGWHITE='\e[0;100;37m'

# GET BOT CONFIG
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
export TIME="10"
export URL="https://api.telegram.org/bot$KEY/sendMessage"

clear
echo -e "${GREEN}loading...${NC}"
sleep 1
clear

checking_sc(){ return 0; }
checking_sc
clear

domain=$(cat /etc/xray/domain)

# INPUT USER
until [[ $user =~ ^[a-zA-Z0-9_]+$ && ${CLIENT_EXISTS} == '0' ]]; do
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${WHITE}           CREATE VLESS ACCOUNT        ${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
read -rp " Username : " -e user
CLIENT_EXISTS=$(grep -w "$user" /etc/xray/config.json | wc -l)

if [[ ${CLIENT_EXISTS} == '1' ]]; then
  clear
  echo -e "${RED}User already exists!${NC}"
  read -n 1 -s -r -p "Press any key to return..."
  m-vless
fi
done

uuid=$(cat /proc/sys/kernel/random/uuid)

read -p " Expired (days)  : " masaaktif
read -p " Quota (GB)       : " Quota
read -p " Limit User (IP)  : " iplimit

exp=$(date -d "$masaaktif days" +"%Y-%m-%d")
tgl=$(date -d "$masaaktif days" +"%d")
bln=$(date -d "$masaaktif days" +"%b")
thn=$(date -d "$masaaktif days" +"%Y")
expe="$tgl $bln, $thn"

tnggl=$(date +"%d %b, %Y")

# INSERT CONFIG XRAY
sed -i '/#vless$/a\### '"$user $exp"'\
},{"id": "'$uuid'","email": "'$user'"' /etc/xray/config.json

sed -i '/#vlessgrpc$/a\### '"$user $exp"'\
"},{"id": "'$uuid'","email": "'$user'"' /etc/xray/config.json

# LINKS
vless_tls="vless://${uuid}@${domain}:443?path=/vless&security=tls&encryption=none&type=ws#${user}"
vless_ntls="vless://${uuid}@${domain}:80?path=/vless&encryption=none&type=ws#${user}"
vless_grpc="vless://${uuid}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=vless-grpc&sni=${domain}#${user}"

# SAVE LIMITS
mkdir -p /etc/vless
mkdir -p /etc/kyt/limit/vless/ip

bytes=$((Quota * 1024 * 1024 * 1024))
echo "$bytes" >/etc/vless/$user
echo "$iplimit" >/etc/kyt/limit/vless/ip/$user

sed -i "/\b$user\b/d" /etc/vless/.vless.db
echo "### $user $exp $uuid $Quota $iplimit" >> /etc/vless/.vless.db

systemctl restart xray >/dev/null
systemctl restart nginx >/dev/null

# OUTPUT INTERFACE LIKE m-vmess
clear
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${WHITE}        STATUS CREATE VLESS SUCCESS      ${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

echo -e "${GREEN}Remarks${NC}      : $user"
echo -e "${GREEN}Domain${NC}       : $domain"
echo -e "${GREEN}Port TLS${NC}     : 400-900"
echo -e "${GREEN}Port NTLS${NC}    : 80, 8080, 8880, 2082"
echo -e "${GREEN}Path${NC}         : /vless"
echo -e "${GREEN}ServiceName${NC}  : vless-grpc"

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "TLS Link     :"
echo -e "$vless_tls"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "NTLS Link    :"
echo -e "$vless_ntls"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "gRPC Link    :"
echo -e "$vless_grpc"

echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "Created On  : $tnggl"
echo -e "Expired On  : $expe"
echo -e "Active For  : $masaaktif Days"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

read -n 1 -s -r -p "Press any key to return..."
m-vless
