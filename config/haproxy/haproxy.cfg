global
    daemon
    user haproxy
    group haproxy
    log /dev/log local0
    log /dev/log local1 notice
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    tune.ssl.default-dh-param 2048
    pidfile /run/haproxy.pid

defaults
    mode tcp
    log global
    option dontlognull
    timeout connect 5s
    timeout client 300s
    timeout server 300s

##############################################
# FRONTEND 80 – TCP + HTTP payload inspection
# - ACME to Nginx:8080
# - WS (non-TLS) routing by path
##############################################
frontend ws_http_80
    mode tcp
    bind *:80

    # Enable HTTP parsing on first bytes while staying in TCP mode
    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP

    # ---- ACME (Let's Encrypt) -> Nginx:8080
    # Match early, before any WS rules; widen the window to 1024 bytes
    acl acme_path  req.payload(0,1024) -m sub /.well-known/acme-challenge/
    acl acme_get   req.payload(0,1024) -m sub "GET /.well-known/acme-challenge/"
    acl acme_head  req.payload(0,1024) -m sub "HEAD /.well-known/acme-challenge/"
    use_backend ACME if acme_path or acme_get or acme_head

    # ---- WebSocket routes by path (non-TLS)
    acl vless    req.payload(0,512) -m sub /vless
    acl vmess    req.payload(0,512) -m sub /vmess
    acl trojan   req.payload(0,512) -m sub /trojan-ws
    acl ssws     req.payload(0,512) -m sub /ss-ws
    acl sshws    req.payload(0,512) -m sub /sshws
    acl fighter  req.payload(0,512) -m sub /fightertunnelssh

    use_backend VLESS_WS if vless
    use_backend VMESS_WS if vmess
    use_backend TROJAN_WS if trojan
    use_backend SS_WS if ssws
    use_backend SSH_WS if sshws or fighter

    # Fallback pool (SSH / OVPN WS)
    default_backend ws_backend_tcp

##############################################
# FRONTEND 443 – DISABLED (TLS handled by Nginx)
##############################################
#frontend ws_https_443
#    mode tcp
#    bind *:443 ssl crt /etc/haproxy/hap.pem no-sslv3 no-tlsv10 no-tlsv11
#    tcp-request inspect-delay 5s
#    tcp-request content accept if HTTP
#    acl vless  req.payload(0,200) -m sub /vless
#    acl vmess  req.payload(0,200) -m sub /vmess
#    acl trojan req.payload(0,200) -m sub /trojan-ws
#    acl ssws   req.payload(0,200) -m sub /ss-ws
#    acl sshws  req.payload(0,200) -m sub /sshws
#    use_backend VLESS_WS if vless
#    use_backend VMESS_WS if vmess
#    use_backend TROJAN_WS if trojan
#    use_backend SS_WS if ssws
#    use_backend SSH_WS if sshws
#    default_backend ws_backend_tcp

##############################################
# BACKENDS
##############################################

# ACME challenge -> Nginx webroot (port 8080)
backend ACME
    mode tcp
    server web 127.0.0.1:8080

# Default pool for WS when no explicit path matched
backend ws_backend_tcp
    mode tcp
    balance roundrobin
    server ssh_ws  127.0.0.1:10015
    server ovpn_ws 127.0.0.1:10012

backend SSH_WS
    mode tcp
    server ssh_srv 127.0.0.1:10015

backend VLESS_WS
    mode tcp
    server vless_srv 127.0.0.1:10001

backend VMESS_WS
    mode tcp
    server vmess_srv 127.0.0.1:10002

backend TROJAN_WS
    mode tcp
    server trojan_srv 127.0.0.1:10003

backend SS_WS
    mode tcp
    server ss_srv 127.0.0.1:10004
