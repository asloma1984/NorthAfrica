#!/bin/bash
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# System Request : Debian 9 to 13 / Ubuntu 18 to 25
# Developer  » Abdul (NorthAfrica Script)
# Channel    » https://t.me/northafrica9
# Group      » https://t.me/groupnorthafrica
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Base repository (your GitHub)
REPO="https://raw.githubusercontent.com/asloma1984/NorthAfrica/main/"

# ─────────────────────────────────────────────
# Download systemd services for traffic limits
#  (PATH = config/services/*.service)
# ─────────────────────────────────────────────
wget -q -O /etc/systemd/system/limitvmess.service \
    "${REPO}config/services/limitvmess.service" >/dev/null 2>&1
chmod +x /etc/systemd/system/limitvmess.service >/dev/null 2>&1

wget -q -O /etc/systemd/system/limitvless.service \
    "${REPO}config/services/limitvless.service" >/dev/null 2>&1
chmod +x /etc/systemd/system/limitvless.service >/dev/null 2>&1

wget -q -O /etc/systemd/system/limittrojan.service \
    "${REPO}config/services/limittrojan.service" >/dev/null 2>&1
chmod +x /etc/systemd/system/limittrojan.service >/dev/null 2>&1

wget -q -O /etc/systemd/system/limitshadowsocks.service \
    "${REPO}config/services/limitshadowsocks.service" >/dev/null 2>&1
chmod +x /etc/systemd/system/limitshadowsocks.service >/dev/null 2>&1

# ─────────────────────────────────────────────
# Download XRAY traffic-limit helper scripts
#  (PATH = files/vmess|vless|trojan|shadowsocks)
# ─────────────────────────────────────────────
wget -q -O /etc/xray/limit.vmess "${REPO}files/vmess" >/dev/null 2>&1
wget -q -O /etc/xray/limit.vless "${REPO}files/vless" >/dev/null 2>&1
wget -q -O /etc/xray/limit.trojan "${REPO}files/trojan" >/dev/null 2>&1
wget -q -O /etc/xray/limit.shadowsocks "${REPO}files/shadowsocks" >/dev/null 2>&1

chmod +x /etc/xray/limit.vmess >/dev/null 2>&1
chmod +x /etc/xray/limit.vless >/dev/null 2>&1
chmod +x /etc/xray/limit.trojan >/dev/null 2>&1
chmod +x /etc/xray/limit.shadowsocks >/dev/null 2>&1

# Reload systemd and enable limit services
systemctl daemon-reload
systemctl enable --now limitvmess >/dev/null 2>&1
systemctl enable --now limitvless >/dev/null 2>&1
systemctl enable --now limittrojan >/dev/null 2>&1
systemctl enable --now limitshadowsocks >/dev/null 2>&1

# ─────────────────────────────────────────────
# Download limit-ip main script (files/limit-ip)
# ─────────────────────────────────────────────
cd
wget -q -O /usr/bin/limit-ip "${REPO}files/limit-ip" >/dev/null 2>&1
chmod +x /usr/bin/limit-ip >/dev/null 2>&1
sed -i 's/\r//' /usr/bin/limit-ip

# ─────────────────────────────────────────────
# Create systemd services for IP limiter
# ─────────────────────────────────────────────

# LIMIT IP VMESS
cat >/etc/systemd/system/vmip.service << EOF
[Unit]
Description=Limit IP for VMESS clients
After=network.target

[Service]
WorkingDirectory=/root
ExecStart=/usr/bin/limit-ip vmip
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# LIMIT IP VLESS
cat >/etc/systemd/system/vlip.service << EOF
[Unit]
Description=Limit IP for VLESS clients
After=network.target

[Service]
WorkingDirectory=/root
ExecStart=/usr/bin/limit-ip vlip
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# LIMIT IP TROJAN
cat >/etc/systemd/system/trip.service << EOF
[Unit]
Description=Limit IP for TROJAN clients
After=network.target

[Service]
WorkingDirectory=/root
ExecStart=/usr/bin/limit-ip trip
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Reload and start IP-limit services
systemctl daemon-reload
systemctl restart vmip >/dev/null 2>&1
systemctl enable  vmip >/dev/null 2>&1
systemctl restart vlip >/dev/null 2>&1
systemctl enable  vlip >/dev/null 2>&1
systemctl restart trip >/dev/null 2>&1
systemctl enable  trip >/dev/null 2>&1

# Clean up
rm -f /root/fv-tunnel
clear
echo "fv-tunnel & limit-ip installation completed."