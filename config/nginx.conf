user www-data;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile on;
    keepalive_timeout  65;

    server_tokens off;

    #######################################################
    # SERVER: 8080 (ACME + WebSocket reverse proxy)
    #######################################################
    server {
        listen 8080;
        listen [::]:8080;

        # NOTE:
        #   "xxx" will be replaced by install script:
        #   sed -i "s/xxx/${domain}/g" /etc/nginx/nginx.conf
        server_name xxx;

        # ACME challenge from HAProxy
        location ^~ /.well-known/acme-challenge/ {
            root /var/www/html;
            try_files $uri =404;
        }

        ###################################################
        # WebSocket upstreams â€” HAProxy forwards here (WS)
        ###################################################
        location /vless {
            proxy_pass http://127.0.0.1:10001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /vmess {
            proxy_pass http://127.0.0.1:10002;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /trojan-ws {
            proxy_pass http://127.0.0.1:10003;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /ss-ws {
            proxy_pass http://127.0.0.1:10004;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        location /sshws {
            proxy_pass http://127.0.0.1:10015;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        location /openvpn {
            proxy_pass http://127.0.0.1:10012;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        ###################################################
        # gRPC FORWARD (Xray)
        ###################################################
        location /vless-grpc {
            grpc_pass grpc://127.0.0.1:10005;
        }

        location /vmess-grpc {
            grpc_pass grpc://127.0.0.1:10006;
        }

        location /trojan-grpc {
            grpc_pass grpc://127.0.0.1:10007;
        }

        location /ss-grpc {
            grpc_pass grpc://127.0.0.1:10008;
        }

        ###################################################
        # Fallback 404
        ###################################################
        location / {
            return 404;
        }
    }
}