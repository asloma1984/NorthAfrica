global
    daemon
    user haproxy
    group haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 1d
    tune.h2.initial-window-size 2147483647
    tune.ssl.default-dh-param 2048
    pidfile /run/haproxy.pid

defaults
    mode http
    log global
    option dontlognull
    timeout connect 5s
    timeout client 300s
    timeout server 300s

# ======================================================
# WEBSOCKET PORT 80 (TCP PASSTHROUGH)
# ======================================================
frontend ws_http_80
    mode tcp
    bind *:80
    default_backend ws_backend

# ======================================================
# WEBSOCKET PORT 443 (SSL PASSTHROUGH)
# ======================================================
frontend ws_https_443
    mode tcp
    # Note: SSL PASSTHROUGH â€” no ALPN, no HTTP mode
    bind *:443 ssl crt /etc/haproxy/hap.pem no-sslv3 no-tlsv10 no-tlsv11
    default_backend ws_backend

# ======================================================
# MULTIPORT FRONTEND
# ======================================================
frontend multiport
    mode tcp
    bind *:222-442 tfo
    bind *:444-1000 tfo
    bind *:2053 tfo
    bind *:2083 tfo
    bind *:2096 tfo
    bind *:2087 tfo
    bind *:8443 tfo

    tcp-request inspect-delay 500ms
    tcp-request content accept if HTTP

    use_backend recir_http if HTTP
    default_backend recir_https

# ======================================================
# SSL FRONTEND (YOUR ORIGINAL CONFIG)
# ======================================================
frontend ssl
    mode tcp
    bind *:55 tfo
    bind *:8080 tfo
    bind *:8880 tfo
    bind *:2052 tfo
    bind *:2086 tfo
    bind *:2095 tfo
    bind *:2097 tfo
    bind *:2098 tfo
    bind *:2082 tfo
    bind *:2092 tfo
    bind *:2022 tfo

    bind abns@http-sock accept-proxy ssl crt /etc/haproxy/hap.pem no-sslv3 no-tlsv10 no-tlsv11 tfo

    tcp-request inspect-delay 500ms
    tcp-request content capture req.ssl_sni len 100
    tcp-request content accept if { req.ssl_hello_type 1 }

    acl is_grpc     ssl_fc_alpn -i h2
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_http     path_reg -i ^\/(.*)

    use_backend GRUP_FTVPN if is_grpc
    use_backend FTVPN if is_websocket
    use_backend FTVPN if is_http
    default_backend CHANNEL_FTVPN

# ======================================================
# RECIRCULATION FRONTENDS
# ======================================================
frontend http_recir
    mode http
    bind abns@haproxy-http
    default_backend FTVPN

frontend https_recir
    mode tcp
    bind abns@https-sock
    default_backend FTVPN

# ======================================================
# BACKENDS
# ======================================================

# WebSocket backend
backend ws_backend
    mode tcp
    option tcp-check
    server sshws 127.0.0.1:10015 check

# Recirculation backends
backend recir_http
    mode tcp
    server loop-http abns@haproxy-http send-proxy-v2 check

backend recir_https
    mode tcp
    server loop-https abns@https-sock send-proxy-v2 check

# FTVPN backend
backend FTVPN
    mode http
    server srv-ftvpn 127.0.0.1:1010 check

backend GRUP_FTVPN
    mode tcp
    server srv-grup 127.0.0.1:1013 check

backend CHANNEL_FTVPN
    mode tcp
    balance roundrobin
    server srv1 127.0.0.1:1194 check
    server srv2 127.0.0.1:1012 check

backend BOT_FTVPN
    mode tcp
    server srv-bot 127.0.0.1:2222 check