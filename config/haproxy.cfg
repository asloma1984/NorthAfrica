global
    daemon
    user haproxy
    group haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 1d
    tune.ssl.default-dh-param 2048
    tune.h2.initial-window-size 2147483647
    pidfile /run/haproxy.pid

defaults
    mode tcp
    log global
    option dontlognull
    timeout connect 5s
    timeout client 300s
    timeout server 300s

# ======================================================
# PORT 80 WebSocket routing (TCP passthrough)
# ======================================================
frontend ws_http_80
    mode tcp
    bind *:80
    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP

    acl is_vless_ws  req.payload(0,200) -m sub /vless
    acl is_vmess_ws  req.payload(0,200) -m sub /vmess
    acl is_trojan_ws req.payload(0,200) -m sub /trojan-ws
    acl is_ss_ws     req.payload(0,200) -m sub /ss-ws

    use_backend VLESS_WS  if is_vless_ws
    use_backend VMESS_WS  if is_vmess_ws
    use_backend TROJAN_WS if is_trojan_ws
    use_backend SS_WS     if is_ss_ws

    default_backend ws_backend

# ======================================================
# PORT 443 WebSocket TLS routing
# ======================================================
frontend ws_https_443
    mode tcp
    bind *:443 ssl crt /etc/haproxy/hap.pem no-sslv3 no-tlsv10 no-tlsv11
    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP

    acl is_vless_ws  req.payload(0,200) -m sub /vless
    acl is_vmess_ws  req.payload(0,200) -m sub /vmess
    acl is_trojan_ws req.payload(0,200) -m sub /trojan-ws
    acl is_ss_ws     req.payload(0,200) -m sub /ss-ws

    use_backend VLESS_WS  if is_vless_ws
    use_backend VMESS_WS  if is_vmess_ws
    use_backend TROJAN_WS if is_trojan_ws
    use_backend SS_WS     if is_ss_ws

    default_backend ws_backend

# ======================================================
# MULTIPORT FRONTEND
# ======================================================
frontend multiport
    mode tcp
    bind *:222-442 tfo
    bind *:444-1000 tfo
    bind *:2053 tfo
    bind *:2083 tfo
    bind *:2096 tfo
    bind *:2087 tfo
    bind *:8443 tfo

    tcp-request inspect-delay 500ms
    tcp-request content accept if HTTP
    use_backend recir_http if HTTP
    default_backend recir_https

# ======================================================
# ORIGINAL SSL FRONTEND
# ======================================================
frontend ssl
    mode tcp
    bind *:55 tfo
    bind *:8080 tfo
    bind *:8880 tfo
    bind *:2052 tfo
    bind *:2086 tfo
    bind *:2095 tfo
    bind *:2097 tfo
    bind *:2098 tfo
    bind *:2082 tfo
    bind *:2092 tfo
    bind *:2022 tfo
    bind abns@http-sock accept-proxy ssl crt /etc/haproxy/hap.pem no-sslv3 no-tlsv10 no-tlsv11 tfo

    tcp-request inspect-delay 500ms
    tcp-request content capture req.ssl_sni len 100
    tcp-request content accept if { req.ssl_hello_type 1 }

    acl is_grpc ssl_fc_alpn -i h2
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_http path_reg -i ^\/(.*)

    use_backend GRUP_FTVPN if is_grpc
    use_backend FTVPN      if is_websocket
    use_backend FTVPN      if is_http

    default_backend CHANNEL_FTVPN

# ======================================================
# RECIRCULATION FRONTENDS
# ======================================================
frontend http_recir
    mode tcp
    bind abns@haproxy-http
    default_backend FTVPN

frontend https_recir
    mode tcp
    bind abns@https-sock
    default_backend FTVPN

# ======================================================
# BACKENDS
# ======================================================

# Default WS backend
backend ws_backend
    mode tcp
    server ssh_ws 127.0.0.1:10015 check
    server ovpn_ws 127.0.0.1:10012 check

# Xray WS Backends (TCP)
backend VLESS_WS
    mode tcp
    server vless_ws 127.0.0.1:10001 check

backend VMESS_WS
    mode tcp
    server vmess_ws 127.0.0.1:10002 check

backend TROJAN_WS
    mode tcp
    server trojan_ws 127.0.0.1:10003 check

backend SS_WS
    mode tcp
    server ss_ws 127.0.0.1:10004 check

# Recirculation Backends
backend recir_http
    mode tcp
    server loop-http abns@haproxy-http send-proxy-v2 check

backend recir_https
    mode tcp
    server loop-https abns@https-sock send-proxy-v2 check

# Original VPN Backends
backend FTVPN
    mode tcp
    server srv-ftvpn 127.0.0.1:1010 check

backend GRUP_FTVPN
    mode tcp
    server srv-grup 127.0.0.1:1013 check

backend CHANNEL_FTVPN
    mode tcp
    balance roundrobin
    server srv1 127.0.0.1:1194 check
    server srv2 127.0.0.1:1012 check

backend BOT_FTVPN
    mode tcp
    server srv-bot 127.0.0.1:2222 check