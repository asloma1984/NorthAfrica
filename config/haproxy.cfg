global
    daemon
    user haproxy
    group haproxy
    log /dev/log local0
    log /dev/log local1 notice
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    tune.ssl.default-dh-param 2048
    pidfile /run/haproxy.pid

defaults
    mode tcp
    log global
    option dontlognull
    timeout connect 5s
    timeout client 300s
    timeout server 300s

##############################################
# FRONTEND 80 – HTTP WebSocket + ACME
##############################################
frontend ws_http_80
    mode tcp
    bind *:80

    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP

    # ACME (HTTP-01 challenge)
    acl acme req.payload(0,1024) -m sub /.well-known/acme-challenge/
    use_backend ACME if acme

    # WebSocket routes (all forwarded to Nginx 8080)
    acl ws_path req.payload(0,512) -m sub /vless
    acl ws_path req.payload(0,512) -m sub /vmess
    acl ws_path req.payload(0,512) -m sub /trojan-ws
    acl ws_path req.payload(0,512) -m sub /ss-ws
    acl ws_path req.payload(0,512) -m sub /sshws
    acl ws_path req.payload(0,512) -m sub /openvpn

    use_backend NGINX_WS if ws_path

    default_backend NGINX_WS

##############################################
# FRONTEND 443 – HTTPS WebSocket + ACME + SNI
##############################################
frontend ws_https_443
    mode tcp
    bind *:443 ssl crt /etc/haproxy/hap.pem alpn h2,http/1.1

    tcp-request inspect-delay 5s

    # SNI Domain
    # NOTE: "xxx" will be replaced automatically by install script
    #       with your real domain using: sed -i "s/xxx/${domain}/g"
    acl main_domain req.ssl_sni -i xxx

    # Unknown SNI → SSH over TLS
    use_backend SSH_TLS if !main_domain

    # ACME inside TLS (HTTPS-01 challenge)
    acl acme_tls req.payload(0,1024) -m sub /.well-known/acme-challenge/
    use_backend ACME if acme_tls

    # Forward ALL WebSocket traffic to Nginx
    use_backend NGINX_WS

##############################################
# BACKENDS
##############################################

# ACME → Nginx
backend ACME
    mode tcp
    server web 127.0.0.1:8080

# All WebSockets go to Nginx 8080
backend NGINX_WS
    mode tcp
    server nginx_ws 127.0.0.1:8080

# SSH over TLS (fallback for unknown SNI)
backend SSH_TLS
    mode tcp
    server ssh_tls 127.0.0.1:22