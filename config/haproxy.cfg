global
    daemon
    user haproxy
    group haproxy
    log /dev/log local0
    log /dev/log local1 notice
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    tune.ssl.default-dh-param 2048
    pidfile /run/haproxy.pid

defaults
    mode tcp
    log global
    option dontlognull
    timeout connect 5s
    timeout client 300s
    timeout server 300s

##############################################
# :80  (WebSocket + ACME + HTTP CONNECT -> Squid)
##############################################
frontend ws_http_80
    mode tcp
    bind *:80
    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP

    # CONNECT payload -> Squid
    acl is_connect_http req.payload(0,8) -m str "CONNECT "
    use_backend PROXY_HTTP if is_connect_http

    # ACME -> Nginx:8080
    acl acme_http req.payload(0,1024) -m sub "/.well-known/acme-challenge/"
    use_backend ACME if acme_http

    # WebSocket paths
    acl vless_path   req.payload(0,2048) -m sub "GET /vless"
    acl vmess_path   req.payload(0,2048) -m sub "GET /vmess"
    acl trojan_path  req.payload(0,2048) -m sub "GET /trojan-ws"
    acl ssws_path    req.payload(0,2048) -m sub "GET /ss-ws"
    acl sshws_path   req.payload(0,2048) -m sub "GET /sshws"
    acl fighter_path req.payload(0,2048) -m sub "GET /fightertunnelssh"
    acl ovpnws_path  req.payload(0,2048) -m sub "GET /ovpn-ws"

    use_backend VLESS_WS  if vless_path
    use_backend VMESS_WS  if vmess_path
    use_backend TROJAN_WS if trojan_path
    use_backend SS_WS     if ssws_path
    use_backend SSH_WS    if sshws_path or fighter_path
    use_backend OVPN_WS   if ovpnws_path

    default_backend ws_backend_tcp

##############################################
# :443 (TLS terminate + CONNECT->Squid + SNI bughost + WebSocket)
##############################################
frontend ws_https_443
    mode tcp
    bind *:443 ssl crt /etc/haproxy/hap.pem alpn http/1.1
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.len gt 0 }

    # 1) CONNECT payload (SSL) -> Squid
    acl is_connect_ssl req.payload(0,8) -m str "CONNECT "
    use_backend PROXY_SSL if is_connect_ssl

    # 2) SNI handling (main domain vs bughost)
    acl has_sni     ssl_fc_sni -m found
    acl main_domain ssl_fc_sni -i __DOMAIN__
    use_backend SSH_SSL if has_sni !main_domain

    # ACME HTTPS -> Nginx:8080
    acl acme_https req.payload(0,1024) -m sub "/.well-known/acme-challenge/"
    use_backend ACME if acme_https

    # WebSocket paths over TLS
    acl vless_tls   req.payload(0,2048) -m sub "GET /vless"
    acl vmess_tls   req.payload(0,2048) -m sub "GET /vmess"
    acl trojan_tls  req.payload(0,2048) -m sub "GET /trojan-ws"
    acl ssws_tls    req.payload(0,2048) -m sub "GET /ss-ws"
    acl sshws_tls   req.payload(0,2048) -m sub "GET /sshws"
    acl fighter_tls req.payload(0,2048) -m sub "GET /fightertunnelssh"
    acl ovpnws_tls  req.payload(0,2048) -m sub "GET /ovpn-ws"

    use_backend VLESS_WS  if vless_tls
    use_backend VMESS_WS  if vmess_tls
    use_backend TROJAN_WS if trojan_tls
    use_backend SS_WS     if ssws_tls
    use_backend SSH_WS    if sshws_tls or fighter_tls
    use_backend OVPN_WS   if ovpnws_tls

    default_backend ws_backend_tcp

##############################################
# :8082 (OpenVPN / OHP)
##############################################
frontend openvpn_ohp_8082
    mode tcp
    bind *:8082
    default_backend OVPN_RAW

##############################################
# BACKENDS
##############################################
backend ACME
    mode tcp
    server web 127.0.0.1:8080

backend ws_backend_tcp
    mode tcp
    balance roundrobin
    server ssh_ws  127.0.0.1:10015
    server ovpn_ws 127.0.0.1:10012

backend VLESS_WS
    mode tcp
    server vless_srv 127.0.0.1:10001

backend VMESS_WS
    mode tcp
    server vmess_srv 127.0.0.1:10002

backend TROJAN_WS
    mode tcp
    server trojan_srv 127.0.0.1:10003

backend SS_WS
    mode tcp
    server ss_srv 127.0.0.1:10004

backend SSH_WS
    mode tcp
    server ssh_srv 127.0.0.1:10015

backend OVPN_WS
    mode tcp
    server ovpn_srv 127.0.0.1:10012

backend OVPN_RAW
    mode tcp
    server ovpn_raw 127.0.0.1:1194

backend SSH_SSL
    mode tcp
    server ssh_tls 127.0.0.1:22

backend PROXY_HTTP
    mode tcp
    server squid_http 127.0.0.1:3128

backend PROXY_SSL
    mode tcp
    server squid_ssl 127.0.0.1:3128