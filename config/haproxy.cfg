global
    daemon
    user haproxy
    group haproxy
    log /dev/log local0
    log /dev/log local1 notice
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    tune.ssl.default-dh-param 2048
    pidfile /run/haproxy.pid

defaults
    mode tcp
    log global
    option dontlognull
    timeout connect 5s
    timeout client 300s
    timeout server 300s

##############################################
# FRONTEND 80 - HTTP / WebSocket (no TLS)
# - ACME to Nginx:8080
# - WebSocket routing by path
##############################################
frontend ws_http_80
    mode tcp
    bind *:80

    # Enable HTTP parsing on the first bytes while staying in TCP mode
    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP

    # ---- ACME (Let's Encrypt) -> Nginx:8080
    # Match early, before any WebSocket rules; widen the window to 1024 bytes
    acl acme_path      req.payload(0,1024) -m sub /.well-known/acme-challenge/
    acl acme_get       req.payload(0,1024) -m sub "GET /.well-known/acme-challenge/"
    acl acme_head      req.payload(0,1024) -m sub "HEAD /.well-known/acme-challenge/"
    use_backend ACME if acme_path or acme_get or acme_head

    # ---- WebSocket routes (plain HTTP, no TLS)
    acl vless_path     req.payload(0,512) -m sub /vless
    acl vmess_path     req.payload(0,512) -m sub /vmess
    acl trojan_path    req.payload(0,512) -m sub /trojan-ws
    acl ssws_path      req.payload(0,512) -m sub /ss-ws
    acl sshws_path     req.payload(0,512) -m sub /sshws
    acl fighter_path   req.payload(0,512) -m sub /fightertunnelssh
    acl ovpn_ws_path   req.payload(0,512) -m sub /ovpn-ws      # OpenVPN over WebSocket

    use_backend VLESS_WS if vless_path
    use_backend VMESS_WS if vmess_path
    use_backend TROJAN_WS if trojan_path
    use_backend SS_WS    if ssws_path
    use_backend SSH_WS   if sshws_path or fighter_path
    use_backend OVPN_WS  if ovpn_ws_path

    # Fallback pool (SSH / OpenVPN WS)
    default_backend ws_backend_tcp

##############################################
# FRONTEND 443 - TLS WebSocket + AUTO SNI â†’ SSH or WS
# - HAProxy terminates TLS on 443
# - Any SNI != main domain -> SSH over TLS (bug host / HTTP Injector style)
# - Main domain + HTTP -> WebSocket / ACME / Xray
##############################################
frontend ws_https_443
    mode tcp
    bind *:443 ssl crt /etc/haproxy/hap.pem alpn h2,http/1.1

    # Wait up to 5s so we can read TLS ClientHello and payload for ACLs
    tcp-request inspect-delay 5s

    # Main domain SNI
    # "xxx" will be replaced by install script:
    #   sed -i "s/xxx/${domain}/g" /etc/haproxy/haproxy.cfg
    acl main_domain  req.ssl_sni -i xxx

    # Any SNI that is NOT the main domain => SSH over TLS (bug host)
    use_backend SSH_SSL if !main_domain

    # ---- HTTP/WS traffic for main_domain (and clients without SNI) ----
    # ACME over HTTPS -> Nginx:8080
    acl acme_path_ssl   req.payload(0,1024) -m sub /.well-known/acme-challenge/
    acl acme_get_ssl    req.payload(0,1024) -m sub "GET /.well-known/acme-challenge/"
    acl acme_head_ssl   req.payload(0,1024) -m sub "HEAD /.well-known/acme-challenge/"
    use_backend ACME if acme_path_ssl or acme_get_ssl or acme_head_ssl

    # WebSocket paths over TLS
    acl vless_tls_path    req.payload(0,512) -m sub /vless
    acl vmess_tls_path    req.payload(0,512) -m sub /vmess
    acl trojan_tls_path   req.payload(0,512) -m sub /trojan-ws
    acl ssws_tls_path     req.payload(0,512) -m sub /ss-ws
    acl sshws_tls_path    req.payload(0,512) -m sub /sshws
    acl fighter_tls_path  req.payload(0,512) -m sub /fightertunnelssh
    acl ovpn_ws_tls_path  req.payload(0,512) -m sub /ovpn-ws       # OpenVPN over WebSocket (TLS)

    use_backend VLESS_WS if vless_tls_path
    use_backend VMESS_WS if vmess_tls_path
    use_backend TROJAN_WS if trojan_tls_path
    use_backend SS_WS    if ssws_tls_path
    use_backend SSH_WS   if sshws_tls_path or fighter_tls_path
    use_backend OVPN_WS  if ovpn_ws_tls_path

    # Default backend (SSH / OpenVPN WS) if no explicit path matched
    default_backend ws_backend_tcp

##############################################
# FRONTEND 8082 - OpenVPN "OHP-style" through HAProxy
# - Use this in .ovpn as HTTP-entry port (optional)
##############################################
frontend openvpn_ohp_8082
    mode tcp
    bind *:8082

    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP

    # Everything on 8082 goes to raw OpenVPN on 1194
    default_backend OVPN_RAW

##############################################
# BACKENDS
##############################################

# ACME challenge -> Nginx webroot (port 8080)
backend ACME
    mode tcp
    server web 127.0.0.1:8080

# Default pool for WS when no explicit path matched
# (SSH WS + OpenVPN WS)
backend ws_backend_tcp
    mode tcp
    balance roundrobin
    server ssh_ws  127.0.0.1:10015
    server ovpn_ws 127.0.0.1:10012

# SSH over WebSocket backend
backend SSH_WS
    mode tcp
    server ssh_srv 127.0.0.1:10015

# VLESS over WebSocket
backend VLESS_WS
    mode tcp
    server vless_srv 127.0.0.1:10001

# VMESS over WebSocket
backend VMESS_WS
    mode tcp
    server vmess_srv 127.0.0.1:10002

# TROJAN over WebSocket
backend TROJAN_WS
    mode tcp
    server trojan_srv 127.0.0.1:10003

# Shadowsocks over WebSocket
backend SS_WS
    mode tcp
    server ss_srv 127.0.0.1:10004

# OpenVPN over WebSocket (wrapper on 10012)
backend OVPN_WS
    mode tcp
    server ovpn_srv 127.0.0.1:10012

# Raw OpenVPN (classic 1194) through HAProxy
backend OVPN_RAW
    mode tcp
    server ovpn_raw 127.0.0.1:1194

# SSH over TLS for any bug host / SNI not equal to the main domain
backend SSH_SSL
    mode tcp
    server ssh_tls 127.0.0.1:22